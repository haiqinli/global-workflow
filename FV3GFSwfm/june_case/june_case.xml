<?xml version="1.0"?>
<!DOCTYPE workflow
[
	<!--
	PROGRAM
		Main workflow manager for Forecast only Global Forecast System

	AUTHOR:
		Rahul Mahajan
		rahul.mahajan@noaa.gov

	NOTES:
		This workflow was automatically generated at 2020-04-01 16:55:49.954977
	-->

	<!-- Experiment parameters such as name, cycle, resolution -->
	<!ENTITY PSLOT    "june_case">
	<!ENTITY CDUMP    "gfs">
	<!ENTITY CASE     "C768">

	<!-- Experiment parameters such as starting, ending dates -->
	<!ENTITY SDATE    "201606111200">
	<!ENTITY EDATE    "201606111200">
	<!ENTITY INTERVAL "24:00:00">

	<!-- Run Envrionment -->
	<!ENTITY RUN_ENVIR "emc">

	<!-- Experiment related directories -->
	<!ENTITY EXPDIR "/scratch1/BMC/gmtb/Judy.K.Henderson/dtc_aop_2019/gmtb_v16beta/FV3GFSwfm/june_case">
	<!ENTITY ROTDIR "/scratch1/BMC/gmtb/Judy.K.Henderson/dtc_aop_2019/gmtb_v16beta/FV3GFSrun/june_case">
	<!ENTITY ICSDIR "/scratch1/BMC/gmtb/Judy.K.Henderson/dtc_aop_2019/gmtb_v16beta/FV3GFSrun/FV3ICS">

	<!-- Directories for driving the workflow -->
	<!ENTITY HOMEgfs  "/scratch1/BMC/gmtb/Judy.K.Henderson/dtc_aop_2019/gmtb_v16beta">
	<!ENTITY JOBS_DIR "/scratch1/BMC/gmtb/Judy.K.Henderson/dtc_aop_2019/gmtb_v16beta/jobs/rocoto">

	<!-- Machine related entities -->
	<!ENTITY ACCOUNT    "gmtb">
	<!ENTITY QUEUE      "batch">
	<!ENTITY QUEUE_DEBUG "debug">
	<!ENTITY QUEUE_ARCH "service">
	<!ENTITY PARTITION_ARCH "service">
	<!ENTITY SCHEDULER  "slurm">

	<!-- Toggle HPSS archiving -->
	<!ENTITY ARCHIVE_TO_HPSS "YES">

	<!-- ROCOTO parameters that control workflow -->
	<!ENTITY CYCLETHROTTLE "2">
	<!ENTITY TASKTHROTTLE  "25">
	<!ENTITY MAXTRIES      "2">

	<!-- BEGIN: Resource requirements for the workflow -->

	<!ENTITY QUEUE_GETIC_GFS     "&QUEUE;">
	<!ENTITY PARTITION_GETIC_GFS "&PARTITION_ARCH;">
	<!ENTITY WALLTIME_GETIC_GFS  "06:00:00">
	<!ENTITY RESOURCES_GETIC_GFS "<nodes>1:ppn=1:tpp=1</nodes>">
	<!ENTITY MEMORY_GETIC_GFS    "2048M">
	<!ENTITY NATIVE_GETIC_GFS    "--export=NONE">

	<!ENTITY QUEUE_FV3IC_GFS     "&QUEUE_DEBUG;">
	<!ENTITY QUEUE_FV3IC_GFS     "&QUEUE;">
	<!ENTITY WALLTIME_FV3IC_GFS  "00:30:00">
	<!ENTITY RESOURCES_FV3IC_GFS "<nodes>1:ppn=4:tpp=1</nodes>">
	<!ENTITY NATIVE_FV3IC_GFS    "--export=NONE">

	<!ENTITY QUEUE_FCST_GFS     "&QUEUE;">
	<!ENTITY WALLTIME_FCST_GFS  "06:30:00">
	<!ENTITY RESOURCES_FCST_GFS "<nodes>90:ppn=10:tpp=4</nodes>">
	<!ENTITY NATIVE_FCST_GFS    "--export=NONE">

	<!ENTITY QUEUE_POST_GFS     "&QUEUE;">
	<!ENTITY QUEUE_POST_GFS     "&QUEUE_DEBUG;">
	<!ENTITY WALLTIME_POST_GFS  "00:30:00">
	<!ENTITY WALLTIME_POST_GFS  "01:00:00">
	<!ENTITY RESOURCES_POST_GFS "<nodes>4:ppn=12:tpp=1</nodes>">
	<!ENTITY NATIVE_POST_GFS    "--export=NONE">

	<!ENTITY QUEUE_ARCH_GFS     "&QUEUE;">
	<!ENTITY PARTITION_ARCH_GFS "&PARTITION_ARCH;">
	<!ENTITY WALLTIME_ARCH_GFS  "02:00:00">
	<!ENTITY RESOURCES_ARCH_GFS "<nodes>1:ppn=1:tpp=1</nodes>">
	<!ENTITY MEMORY_ARCH_GFS    "2048M">
	<!ENTITY NATIVE_ARCH_GFS    "--export=NONE">

	<!-- END: Resource requirements for the workflow -->

]>

<workflow realtime="F" scheduler="&SCHEDULER;" cyclethrottle="&CYCLETHROTTLE;" taskthrottle="&TASKTHROTTLE;">

	<log verbosity="10"><cyclestr>&EXPDIR;/logs/@Y@m@d@H.log</cyclestr></log>

	<!-- Define the cycles -->
	<cycledef group="gfs">&SDATE; &EDATE; &INTERVAL;</cycledef>

<task name="gfsgetic" cycledefs="gfs" maxtries="&MAXTRIES;">

	<command>&JOBS_DIR;/getic.sh</command>

	<jobname><cyclestr>&PSLOT;_gfsgetic_@H</cyclestr></jobname>
	<account>&ACCOUNT;</account>
	<queue>&QUEUE_GETIC_GFS;</queue>
	<partition>&PARTITION_GETIC_GFS;</partition>
	&RESOURCES_GETIC_GFS;
	<walltime>&WALLTIME_GETIC_GFS;</walltime>
	<memory>&MEMORY_GETIC_GFS;</memory>
	<native>&NATIVE_GETIC_GFS;</native>

	<join><cyclestr>&ROTDIR;/logs/@Y@m@d@H/gfsgetic.log</cyclestr></join>

	<envar><name>RUN_ENVIR</name><value>&RUN_ENVIR;</value></envar>
	<envar><name>HOMEgfs</name><value>&HOMEgfs;</value></envar>
	<envar><name>EXPDIR</name><value>&EXPDIR;</value></envar>
	<envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
	<envar><name>CDUMP</name><value>&CDUMP;</value></envar>
	<envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
	<envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>

	<dependency>
		<not>
			<or>
				<datadep><cyclestr>&ICSDIR;/@Y@m@d@H/&CDUMP;/&CDUMP;.@Y@m@d/@H/siganl.&CDUMP;.@Y@m@d@H</cyclestr></datadep>
				<datadep><cyclestr>&ICSDIR;/@Y@m@d@H/&CDUMP;/&CDUMP;.@Y@m@d/@H/&CDUMP;.t@Hz.sanl</cyclestr></datadep>
				<datadep><cyclestr>&ICSDIR;/@Y@m@d@H/&CDUMP;/&CDUMP;.@Y@m@d/@H/gfnanl.&CDUMP;.@Y@m@d@H</cyclestr></datadep>
				<datadep><cyclestr>&ICSDIR;/@Y@m@d@H/&CDUMP;/&CDUMP;.@Y@m@d/@H/&CDUMP;.t@Hz.atmanl.nemsio</cyclestr></datadep>
			</or>
		</not>
	</dependency>

</task>

<task name="gfsfv3ic" cycledefs="gfs" maxtries="&MAXTRIES;">

	<command>&JOBS_DIR;/fv3ic.sh</command>

	<jobname><cyclestr>&PSLOT;_gfsfv3ic_@H</cyclestr></jobname>
	<account>&ACCOUNT;</account>
	<queue>&QUEUE_FV3IC_GFS;</queue>
	&RESOURCES_FV3IC_GFS;
	<walltime>&WALLTIME_FV3IC_GFS;</walltime>
	
	<native>&NATIVE_FV3IC_GFS;</native>

	<join><cyclestr>&ROTDIR;/logs/@Y@m@d@H/gfsfv3ic.log</cyclestr></join>

	<envar><name>RUN_ENVIR</name><value>&RUN_ENVIR;</value></envar>
	<envar><name>HOMEgfs</name><value>&HOMEgfs;</value></envar>
	<envar><name>EXPDIR</name><value>&EXPDIR;</value></envar>
	<envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
	<envar><name>CDUMP</name><value>&CDUMP;</value></envar>
	<envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
	<envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>

	<dependency>
		<and>
			<or>
				<datadep><cyclestr>&ICSDIR;/@Y@m@d@H/&CDUMP;/&CDUMP;.@Y@m@d/@H/siganl.&CDUMP;.@Y@m@d@H</cyclestr></datadep>
				<datadep><cyclestr>&ICSDIR;/@Y@m@d@H/&CDUMP;/&CDUMP;.@Y@m@d/@H/&CDUMP;.t@Hz.sanl</cyclestr></datadep>
				<datadep><cyclestr>&ICSDIR;/@Y@m@d@H/&CDUMP;/&CDUMP;.@Y@m@d/@H/gfnanl.&CDUMP;.@Y@m@d@H</cyclestr></datadep>
				<datadep><cyclestr>&ICSDIR;/@Y@m@d@H/&CDUMP;/&CDUMP;.@Y@m@d/@H/&CDUMP;.t@Hz.atmanl.nemsio</cyclestr></datadep>
			</or>
			<not>
				<and>
					<datadep><cyclestr>&ICSDIR;/@Y@m@d@H/&CDUMP;/&CASE;/INPUT/gfs_data.tile6.nc</cyclestr></datadep>
					<datadep><cyclestr>&ICSDIR;/@Y@m@d@H/&CDUMP;/&CASE;/INPUT/sfc_data.tile6.nc</cyclestr></datadep>
				</and>
			</not>
		</and>
	</dependency>

</task>

<task name="gfsfcst" cycledefs="gfs" maxtries="&MAXTRIES;">

	<command>&JOBS_DIR;/fcst.sh</command>

	<jobname><cyclestr>&PSLOT;_gfsfcst_@H</cyclestr></jobname>
	<account>&ACCOUNT;</account>
	<queue>&QUEUE_FCST_GFS;</queue>
	&RESOURCES_FCST_GFS;
	<walltime>&WALLTIME_FCST_GFS;</walltime>
	
	<native>&NATIVE_FCST_GFS;</native>

	<join><cyclestr>&ROTDIR;/logs/@Y@m@d@H/gfsfcst.log</cyclestr></join>

	<envar><name>RUN_ENVIR</name><value>&RUN_ENVIR;</value></envar>
	<envar><name>HOMEgfs</name><value>&HOMEgfs;</value></envar>
	<envar><name>EXPDIR</name><value>&EXPDIR;</value></envar>
	<envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
	<envar><name>CDUMP</name><value>&CDUMP;</value></envar>
	<envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
	<envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>

	<dependency>
		<and>
			<datadep><cyclestr>&ICSDIR;/@Y@m@d@H/&CDUMP;/&CASE;/INPUT/gfs_data.tile6.nc</cyclestr></datadep>
			<datadep><cyclestr>&ICSDIR;/@Y@m@d@H/&CDUMP;/&CASE;/INPUT/sfc_data.tile6.nc</cyclestr></datadep>
		</and>
	</dependency>

</task>

<metatask name="gfspost">

	<var name="grp">001 002 003 004 005 006 007 008 009 010 011 012 013 014 015 016 017 018 019 020 021 022 023 024 025 026 027 028 029 030 031 032 033 034 035 036 037 038 039 040 041 042</var>
	<var name="dep">f001 f003 f005 f007 f009 f011 f013 f015 f017 f019 f021 f023 f025 f027 f029 f031 f033 f035 f037 f039 f041 f043 f045 f047 f049 f051 f053 f055 f057 f059 f061 f062 f063 f064 f065 f066 f067 f068 f069 f070 f071 f072</var>
	<var name="lst">f000_f001 f002_f003 f004_f005 f006_f007 f008_f009 f010_f011 f012_f013 f014_f015 f016_f017 f018_f019 f020_f021 f022_f023 f024_f025 f026_f027 f028_f029 f030_f031 f032_f033 f034_f035 f036_f037 f038_f039 f040_f041 f042_f043 f044_f045 f046_f047 f048_f049 f050_f051 f052_f053 f054_f055 f056_f057 f058_f059 f060_f061 f062 f063 f064 f065 f066 f067 f068 f069 f070 f071 f072</var>

	<task name="gfspost#grp#" cycledefs="gfs" maxtries="&MAXTRIES;">

		<command>&JOBS_DIR;/post.sh</command>

		<jobname><cyclestr>&PSLOT;_gfspost#grp#_@H</cyclestr></jobname>
		<account>&ACCOUNT;</account>
		<queue>&QUEUE_POST_GFS;</queue>
		&RESOURCES_POST_GFS;
		<walltime>&WALLTIME_POST_GFS;</walltime>
		
		<native>&NATIVE_POST_GFS;</native>

		<join><cyclestr>&ROTDIR;/logs/@Y@m@d@H/gfspost#grp#.log</cyclestr></join>

		<envar><name>RUN_ENVIR</name><value>&RUN_ENVIR;</value></envar>
		<envar><name>HOMEgfs</name><value>&HOMEgfs;</value></envar>
		<envar><name>EXPDIR</name><value>&EXPDIR;</value></envar>
		<envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
		<envar><name>CDUMP</name><value>&CDUMP;</value></envar>
		<envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
		<envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
		<envar><name>FHRGRP</name><value>#grp#</value></envar>
		<envar><name>FHRLST</name><value>#lst#</value></envar>
		<envar><name>ROTDIR</name><value>&ROTDIR;</value></envar>

		<dependency>
			<datadep><cyclestr>&ROTDIR;/gfs.@Y@m@d/@H/gfs.t@Hz.log#dep#.txt</cyclestr></datadep>
		</dependency>

	</task>

</metatask>

<task name="gfsarch" cycledefs="gfs" maxtries="&MAXTRIES;" final="true">

	<command>&JOBS_DIR;/arch.sh</command>

	<jobname><cyclestr>&PSLOT;_gfsarch_@H</cyclestr></jobname>
	<account>&ACCOUNT;</account>
	<queue>&QUEUE_ARCH_GFS;</queue>
	<partition>&PARTITION_ARCH_GFS;</partition>
	&RESOURCES_ARCH_GFS;
	<walltime>&WALLTIME_ARCH_GFS;</walltime>
	<memory>&MEMORY_ARCH_GFS;</memory>
	<native>&NATIVE_ARCH_GFS;</native>

	<join><cyclestr>&ROTDIR;/logs/@Y@m@d@H/gfsarch.log</cyclestr></join>

	<envar><name>RUN_ENVIR</name><value>&RUN_ENVIR;</value></envar>
	<envar><name>HOMEgfs</name><value>&HOMEgfs;</value></envar>
	<envar><name>EXPDIR</name><value>&EXPDIR;</value></envar>
	<envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
	<envar><name>CDUMP</name><value>&CDUMP;</value></envar>
	<envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
	<envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>

	<dependency>
		<and>
			<metataskdep metatask="gfspost"/>
			<streq><left>&ARCHIVE_TO_HPSS;</left><right>YES</right></streq>
		</and>
	</dependency>

</task>


</workflow>
